name: Update Tranco CSV Daily

on:
  schedule:
    - cron: '0 3 * * *'  # Runs daily at 3 AM UTC
  workflow_dispatch:      # Allows manual trigger

jobs:
  update-csv:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Download and Unzip Tranco CSV
      run: |
        pip install requests
        python <<EOF
import requests, zipfile, io, sys

try:
    url = "https://tranco-list.eu/top-1m.csv.zip"
    headers = {
        "User-Agent": "Mozilla/5.0 (compatible; GitHub Actions Workflow)",
        "Accept": "application/zip"
    }
    print(f"Downloading from {url} ...")
    r = requests.get(url, headers=headers)
    print("Response status:", r.status_code)
    print("Content-Type:", r.headers.get("Content-Type"))
    r.raise_for_status()

    # Check if content looks like a zip file by signature (optional sanity check)
    if not r.content.startswith(b'PK'):
        print("Error: downloaded file does not start with 'PK' signature for ZIP files")
        sys.exit(1)

    z = zipfile.ZipFile(io.BytesIO(r.content))
    csv_filename = z.namelist()[0]
    content = z.read(csv_filename).decode()

    with open("top-1m.csv", "w", encoding="utf-8") as f:
        f.write(content)
    print("File written successfully.")
except Exception as e:
    print("Error:", e)
    sys.exit(1)
EOF

    - name: Commit and Push
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"
        git add top-1m.csv
        git commit -m "Update Tranco list [auto]" || echo "No changes to commit"
        git push
